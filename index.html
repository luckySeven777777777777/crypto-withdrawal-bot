<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Withdrawal</title>

<style>
    body {
        background-color: transparent;
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
    }

    .withdraw-box {
        width: 420px;
        margin: 50px auto;
        background: rgba(0, 0, 0, 0.6);
        padding: 25px;
        border-radius: 10px;
        color: white;
    }

    select, input, button {
        width: 100%;
        padding: 10px;
        margin-top: 8px;
        border-radius: 5px;
        border: none;
        background: rgba(255,255,255,0.1);
        color: white;
    }

    button {
        background: #0099cc;
        cursor: pointer;
        font-weight: bold;
    }

    button:disabled {
        background: #444;
        cursor: not-allowed;
    }

    .row {
        display: flex;
        justify-content: space-between;
        gap: 10px;
    }

    #copyHashBtn, #submitBtn {
        display: none;
        width: 48%;
    }

    #usdtText {
        text-align: right;
        color: #00ff00;
        font-size: 12px;
    }

    #hashBox {
        color: #00ff00;
        margin-top: 10px;
        white-space: pre-line;
    }
</style>
</head>
<body>

<div class="withdraw-box">

    <h2 style="text-align:center;"></h2>

    <!-- Select Coin -->
    <label>Select Cryptocurrency</label>
    <select id="coin">
        <option value="BTC">BTC</option>
        <option value="ETH">ETH</option>
        <option value="BNB">BNB</option>
        <option value="USDT">USDT</option>
        <option value="DOGE">DOGE</option>
        <option value="SOL">SOL</option>
        <option value="XRP">XRP</option>
        <option value="ADA">ADA</option>
        <option value="TRX">TRX</option>
    </select>

    <!-- Amount -->
    <label>Enter Coin Amount</label>
    <input id="amount" placeholder="Enter amount" />

    <div id="usdtText">
        USDT Equivalent: <span id="usdtValue">0</span>
    </div>

    <!-- Password -->
    <label>Password</label>
    <input type="password" id="password" />

    <div class="row">
        <button id="createPwdBtn" onclick="createPassword()">Create Password</button>
        <button id="confirmPwdBtn" onclick="confirmPassword()">Confirm Password</button>
    </div>

    <button onclick="forgotPassword()">Forgot Password?</button>

    <!-- Wallet -->
    <label>Wallet Address</label>
    <input id="wallet" placeholder="Paste wallet address" />

    <button id="walletBtn" onclick="confirmWallet()">Confirm Wallet Address</button>

    <div id="hashBox"></div>

    <div class="row">
        <button id="copyHashBtn" onclick="copyHash()">Copy Hash</button>
        <button id="submitBtn" onclick="submitWithdrawal()">Submit Withdrawal</button>
    </div>
</div>

<script>
/* ------------------ Binance Price WebSocket ------------------ */
const prices = {};
let ws = new WebSocket("wss://stream.binance.com:9443/ws/!ticker@arr");

ws.onmessage = msg => {
    const data = JSON.parse(msg.data);
    data.forEach(t => {
        if (t.s.endsWith("USDT")) {
            const coin = t.s.replace("USDT", "");
            prices[coin] = parseFloat(t.c);
        }
    });
    updateUSDT();
};

function updateUSDT() {
    const coin = document.getElementById("coin").value;
    const amount = parseFloat(document.getElementById("amount").value || 0);
    const price = prices[coin] || 0;
    document.getElementById("usdtValue").innerText = (amount * price).toFixed(6);
}

/* ------------------ Password System ------------------ */
let storedPassword = null;
let passwordConfirmed = false;

function createPassword() {
    if (storedPassword) return alert("Password already created.");
    storedPassword = Math.random().toString(36).substr(2, 6).toUpperCase();
    alert("Your Password: " + storedPassword);
    document.getElementById("createPwdBtn").disabled = true;
}

function confirmPassword() {
    const input = document.getElementById("password").value;
    if (input === storedPassword) {
        passwordConfirmed = true;
        alert("Password confirmed!");
    } else {
        alert("Wrong password!");
    }
}

function forgotPassword() {
    if (!storedPassword) return alert("You have not created a password.");
    const oldp = prompt("Enter your current password:");
    if (oldp !== storedPassword) return alert("Wrong password.");
    const newp = prompt("Enter new password:");
    if (newp.length < 4) return alert("Password too short.");
    storedPassword = newp;
    alert("Password updated!");
}

/* ------------------ Wallet & Hash ------------------ */
let txHash = null;

function confirmWallet() {
    if (!passwordConfirmed) return alert("Confirm password first.");
    const wallet = document.getElementById("wallet").value;
    if (!wallet) return alert("Enter wallet address.");

    txHash = "TX-" + Math.random().toString(36).substr(2, 8).toUpperCase();

    document.getElementById("hashBox").innerText = "Transaction Hash:\n" + txHash;

    document.getElementById("copyHashBtn").style.display = "block";
    document.getElementById("submitBtn").style.display = "block";

    document.getElementById("walletBtn").disabled = true;
}

function copyHash() {
    navigator.clipboard.writeText(txHash);
    alert("Hash Copied!");
}

/* ------------------ Submit to Railway Backend ------------------ */
async function submitWithdrawal() {
    const payload = {
        coin: document.getElementById("coin").value,
        amount: document.getElementById("amount").value,
        usdt: document.getElementById("usdtValue").innerText,
        wallet: document.getElementById("wallet").value,
        password: storedPassword,
        hash: txHash
    };

    try {
        const res = await fetch("https://crypto-withdrawal-bot-production.up.railway.app/withdraw", {
            method: "POST",
            mode: "cors",   // ⭐⭐⭐ 我唯一加的内容
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (data.success) {
            alert("Withdrawal submitted!");
        } else {
            alert("Server Error: " + data.error);
        }
    } catch (e) {
        alert("Network error");
    }
}
</script>

</body>
</html>
