<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Withdrawal</title>

<style>
    body {
        background-color: transparent;
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
    }

    .withdraw-box {
        width: 90%;
        max-width: 450px;
        margin: 30px auto;
        background: transparent !important;
        padding: 25px;
        border-radius: 12px;
        color: white;
    }

    select, input, button {
        width: 100%;
        padding: 12px;
        margin-top: 8px;
        border-radius: 6px;
        border: 1px solid rgba(255,255,255,0.6);
        background: transparent !important;
        color: white;
        font-size: 15px;
    }

    select option { color: black; }

    button {
        background: #0099cc;
        cursor: pointer;
        font-weight: bold;
        border: none;
    }

    button:disabled {
        background: #444;
        cursor: not-allowed;
    }

    .row {
        display: flex;
        justify-content: space-between;
        gap: 10px;
    }

    #copyHashBtn, #submitBtn {
        display: none;
        width: 48%;
    }

    #usdtText {
        text-align: right;
        color: #00ff00;
        font-size: 13px;
    }

    #hashBox {
        color: #00ff00;
        margin-top: 10px;
        white-space: pre-line;
        font-size: 14px;
    }
</style>
</head>
<body>

<div class="withdraw-box">

    <h2 style="text-align:center;"></h2>

    <!-- Select Coin -->
    <label>Select Cryptocurrency</label>
    <select id="coin" onchange="updateUSDT()">
        <option value="BTC">BTC</option>
        <option value="ETH">ETH</option>
        <option value="BNB">BNB</option>
        <option value="USDT">USDT</option>
        <option value="USDC">USDC</option>
        <option value="DOGE">DOGE</option>
        <option value="SOL">SOL</option>
        <option value="XRP">XRP</option>
        <option value="ADA">ADA</option>
        <option value="TRX">TRX</option>
        <option value="DOT">DOT</option>
        <option value="LTC">LTC</option>
        <option value="BCH">BCH</option>
        <option value="AVAX">AVAX</option>
        <option value="LINK">LINK</option>
        <option value="XLM">XLM</option>
        <option value="ATOM">ATOM</option>
        <option value="MATIC">MATIC</option>
        <option value="ETC">ETC</option>
        <option value="UNI">UNI</option>
        <option value="AAVE">AAVE</option>
        <option value="EGLD">EGLD</option>
        <option value="HBAR">HBAR</option>
        <option value="ICP">ICP</option>
        <option value="NEAR">NEAR</option>
        <option value="APT">APT</option>
    </select>

    <!-- Amount -->
    <label>Enter Coin Amount</label>
    <input id="amount" placeholder="Enter amount" oninput="updateUSDT()" />

    <div id="usdtText">
        USDT Equivalent: <span id="usdtValue">0</span>
    </div>

    <!-- Password -->
    <label>Password</label>
    <input type="password" id="password" placeholder="Enter password" />

    <div class="row">
        <button id="createPwdBtn" onclick="createPassword()">Create Password</button>
        <button id="confirmPwdBtn" onclick="confirmPassword()">Confirm Password</button>
    </div>

    <button onclick="forgotPassword()">Forgot Password?</button>

    <!-- Wallet -->
    <label>Wallet Address</label>
    <input id="wallet" placeholder="Paste wallet address" />

    <button id="walletBtn" onclick="confirmWallet()">Confirm Wallet Address</button>

    <div id="hashBox"></div>

    <div class="row">
        <button id="copyHashBtn" onclick="copyHash()">Copy Hash</button>
        <button id="submitBtn" onclick="submitWithdrawal()">Submit Withdrawal</button>
    </div>
</div>

<script>
/* -------------------- Binance WebSocket 实时价格同步 -------------------- */
const prices = {};
let ws = new WebSocket("wss://stream.binance.com:9443/ws/!ticker@arr");

ws.onmessage = msg => {
    const data = JSON.parse(msg.data);
    data.forEach(t => {
        if (t.s.endsWith("USDT")) {
            const coin = t.s.replace("USDT", "");
            prices[coin] = parseFloat(t.c);
        }
    });

    updateUSDT();
};

function updateUSDT() {
    const coin = document.getElementById("coin").value;
    const amount = parseFloat(document.getElementById("amount").value || 0);
    const price = prices[coin] || 0;

    document.getElementById("usdtValue").innerText = (amount * price).toFixed(6);
}

/* -------------------- Password System (localStorage 永久保存) -------------------- */
let storedPassword = localStorage.getItem("withdraw_password");
let passwordConfirmed = false;

window.onload = () => {
    if (storedPassword) {
        document.getElementById("createPwdBtn").style.display = "none";
    }
};

function createPassword() {
    if (storedPassword) {
        alert("Password already created, please confirm or reset.");
        return;
    }

    storedPassword = Math.random().toString(36).substr(2, 6).toUpperCase();
    localStorage.setItem("withdraw_password", storedPassword);

    alert("Your Password: " + storedPassword);
    document.getElementById("createPwdBtn").style.display = "none";
}

function confirmPassword() {
    const input = document.getElementById("password").value;
    if (input === storedPassword) {
        passwordConfirmed = true;
        alert("Password confirmed!");
    } else {
        alert("Wrong password!");
    }
}

function forgotPassword() {
    if (!storedPassword) {
        alert("Password not created yet.");
        return;
    }

    const oldp = prompt("Enter your current password:");
    if (oldp !== storedPassword) {
        alert("Wrong password.");
        return;
    }

    const newp = prompt("Enter new password (min 4 chars):");
    if (!newp || newp.length < 4) {
        alert("Password too short.");
        return;
    }

    storedPassword = newp;
    localStorage.setItem("withdraw_password", newp);
    alert("Password updated!");
}

/* -------------------- Wallet & Hash -------------------- */
let txHash = null;

function confirmWallet() {
    if (!passwordConfirmed) return alert("Confirm password first.");
    const wallet = document.getElementById("wallet").value;
    if (!wallet) return alert("Enter wallet address.");

    txHash = "TX-" + Math.random().toString(36).substr(2, 8).toUpperCase();

    document.getElementById("hashBox").innerText = "Transaction Hash:\n" + txHash;

    document.getElementById("copyHashBtn").style.display = "block";
    document.getElementById("submitBtn").style.display = "block";

    document.getElementById("walletBtn").disabled = true;
}

function copyHash() {
    navigator.clipboard.writeText(txHash);
    alert("Hash copied!");
}

/* -------------------- Submit to Railway Backend -------------------- */
async function submitWithdrawal() {
    const payload = {
        coin: document.getElementById("coin").value,
        amount: document.getElementById("amount").value,
        usdt: document.getElementById("usdtValue").innerText,
        wallet: document.getElementById("wallet").value,
        password: storedPassword,
        hash: txHash
    };

    try {
        const res = await fetch("https://crypto-withdrawal-bot-production.up.railway.app/withdraw", {
            method: "POST",
            mode: "cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (data.success) {
            alert("Withdrawal submitted!");
        } else {
            alert("Server Error: " + data.error);
        }
    } catch (e) {
        alert("Network error");
    }
}
</script>

</body>
</html>