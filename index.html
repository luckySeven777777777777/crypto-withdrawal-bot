<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Withdrawal Page</title>

<style>
    body { font-family: Arial; background: transparent; color: #fff; margin:0; padding:0; }
    .container { max-width:480px; margin:40px auto; background:rgba(0,0,0,0.6); padding:20px; border-radius:10px; }

    h2 { text-align:center; font-size:1.3em; margin-bottom:20px; }

    label { display:block; margin-top:12px; font-size:14px; }

    select {
        width:100%; padding:10px; margin-top:6px; border:none;
        border-radius:6px; background:rgba(0,0,0,0.5); color:#fff;
        font-weight:bold;
    }

    input, button {
        width:100%; padding:10px; margin-top:6px; border:none;
        border-radius:6px; background:rgba(255,255,255,0.18); color:#fff;
    }

    button { background:#00bfff; font-weight:bold; cursor:pointer; }
    button:disabled { background:#444; cursor:not-allowed; }

    .row { display:flex; justify-content:space-between; gap:10px; }
    .row button { width:50%; }

    #copyBtn, #submitBtn {
        width:48%;
        display:none;
        margin-top:10px;
    }

    #hashDisplay { margin-top:10px; color:#0f0; white-space:pre-line; font-size:15px; }
</style>
</head>

<body>

<div class="container">
    <h2></h2>

    <label>Select Cryptocurrency</label>
    <select id="coin">
        <option value="BTC">BTC</option>
        <option value="ETH">ETH</option>
        <option value="USDT">USDT</option>
        <option value="BNB">BNB</option>
        <option value="XRP">XRP</option>
        <option value="DOGE">DOGE</option>
        <option value="SOL">SOL</option>
        <option value="TRX">TRX</option>
        <option value="ADA">ADA</option>
        <option value="DOT">DOT</option>
    </select>

    <label>Enter Coin Amount</label>
    <input type="number" id="amount" placeholder="Enter amount">

    <div style="text-align:right; font-size:12px; color:#0f0;">
        USDT Equivalent: <span id="usdtValue">0</span>
    </div>

    <label>Password</label>
    <input type="password" id="password" placeholder="Enter password">

    <div class="row">
        <button id="createPwdBtn" onclick="genPassword()">Create Password</button>
        <button onclick="confirmPassword()">Confirm Password</button>
    </div>

    <button onclick="resetPassword()">Forgot Password?</button>

    <label>Wallet Address</label>
    <input id="wallet" placeholder="Paste wallet address">

    <button id="walletBtn" onclick="confirmWallet()">Confirm Wallet Address</button>

    <div id="hashDisplay"></div>

    <div style="display:flex; justify-content:space-between;">
        <button id="copyBtn" onclick="copyHash()">Copy Hash</button>
        <button id="submitBtn" onclick="sendWithdrawal()">Submit Withdrawal</button>
    </div>
</div>

<script>
let generatedPassword = null;
let confirmedPassword = false;
let hashValue = null;

// ----------------------
// Binance WebSocket ÂÆûÊó∂‰ª∑Ê†º
// ----------------------
let priceFeed = {
    BTC:1, ETH:1, USDT:1, BNB:1, XRP:1, DOGE:1, SOL:1, TRX:1, ADA:1, DOT:1
};

function initPriceFeed() {
    const ws = new WebSocket("wss://stream.binance.com:9443/ws/!ticker@arr");

    ws.onmessage = (msg) => {
        const data = JSON.parse(msg.data);
        data.forEach(t => {
            if (t.s.endsWith("USDT")) {
                let coin = t.s.replace("USDT", "");
                if (priceFeed[coin] !== undefined) {
                    priceFeed[coin] = parseFloat(t.c);
                }
            }
        });
        calcUSDT(); // üî• ÊØèÊ¨°Êî∂Âà∞Êñ∞‰ª∑Ê†ºÈÉΩÂêåÊ≠•Êõ¥Êñ∞
    };
}
initPriceFeed();

// Ëá™Âä®ËÆ°ÁÆó USDT
function calcUSDT() {
    const amount = Number(document.getElementById("amount").value || 0);
    const coin = document.getElementById("coin").value;
    const price = priceFeed[coin] || 1;

    document.getElementById("usdtValue").innerText = (amount * price).toFixed(2);
}

document.getElementById("amount").addEventListener("input", calcUSDT);
document.getElementById("coin").addEventListener("change", calcUSDT);

// ----------------------
// Password Logic
// ----------------------
function genPassword() {
    if (generatedPassword) return alert("Password already created.");

    generatedPassword = Math.random().toString(36).substring(2, 8).toUpperCase();
    alert("Generated Password: " + generatedPassword);

    document.getElementById("createPwdBtn").disabled = true;
}

function confirmPassword() {
    const pwd = document.getElementById("password").value;
    if (!generatedPassword) return alert("Create password first.");
    if (pwd !== generatedPassword) return alert("Incorrect password.");
    confirmedPassword = true;
    alert("Password confirmed.");
}

function resetPassword() {
    if (!generatedPassword) return alert("You have no password.");
    const oldPwd = prompt("Enter old password:");
    if (oldPwd !== generatedPassword) return alert("Incorrect password.");
    const newPwd = prompt("Enter new password:");
    generatedPassword = newPwd;
    alert("Password updated.");
}

// ----------------------
// Confirm wallet (Âè™ËÉΩÁÇπ‰∏ÄÊ¨°Ôºâ
// ----------------------
function confirmWallet() {
    if (!confirmedPassword) return alert("Confirm password first.");

    const wallet = document.getElementById("wallet").value;
    if (!wallet) return alert("Enter wallet address.");

    hashValue = "TX-" + Math.random().toString(36).substring(2, 10).toUpperCase();

    document.getElementById("hashDisplay").innerText =
        "Transaction Hash:\n" + hashValue;

    document.getElementById("walletBtn").disabled = true;
    document.getElementById("copyBtn").style.display = "inline-block";
    document.getElementById("submitBtn").style.display = "inline-block";
}

function copyHash() {
    navigator.clipboard.writeText(hashValue);
    alert("Hash copied!");
}

// ----------------------
// Submit Withdrawal
// ----------------------
async function sendWithdrawal() {
    const btn = document.getElementById("submitBtn");
    btn.disabled = true;

    const payload = {
        coin: document.getElementById("coin").value,
        amount: document.getElementById("amount").value,
        usdt: document.getElementById("usdtValue").innerText,
        wallet: document.getElementById("wallet").value,
        password: generatedPassword,
        hash: hashValue
    };

    try {
        const res = await fetch("/api/wallet", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (data.success) alert("Withdrawal submitted!");
        else alert("Server error: " + data.error);

    } catch(e) {
        alert("Network error");
    }
}
</script>

</body>
</html>
