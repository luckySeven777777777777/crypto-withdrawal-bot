<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Withdrawal Page</title>
<style>
    /* --- 保持你原本的 UI（背景透明且不动） --- */
    body { font-family: Arial; background: transparent; color: #fff; margin:0; padding:0; }
    .container { max-width:480px; margin:40px auto; background:rgba(0,0,0,0.6); padding:20px; border-radius:10px; }

    h2 { text-align:center; font-size:1.2em; margin-bottom:20px; }

    label { display:block; margin-top:12px; font-size:14px; }

    /* 原样 input/select/button 样式，不改动外观 */
    input, select, button {
        width:100%; padding:10px; margin-top:6px; border:none;
        border-radius:6px; background:rgba(255,255,255,0.15); color:#fff;
        box-sizing: border-box;
    }

    /* 币种选择框稍微更清晰，但仍保留透明感 */
    select { background: rgba(0,0,0,0.5); color: #fff; font-weight: bold; }

    button { background:#00bfff; font-weight:bold; cursor:pointer; }
    button:disabled { background:#444; cursor:not-allowed; }

    .row { display:flex; justify-content:space-between; gap:10px; }
    .row button { width:50%; }

    #copyBtn, #submitBtn { width:48%; display:none; margin-top:10px; }

    #hashDisplay { margin-top:10px; color:#0f0; white-space:pre-line; font-size:14px; }
</style>
</head>
<body>

<div class="container">
    <h2>Withdrawal</h2>

    <label>Select Cryptocurrency</label>
    <select id="coin">
        <option value="BTC">BTC</option>
        <option value="ETH">ETH</option>
        <option value="USDT">USDT</option>
        <option value="BNB">BNB</option>
        <option value="XRP">XRP</option>
        <option value="DOGE">DOGE</option>
        <option value="SOL">SOL</option>
        <option value="TRX">TRX</option>
        <option value="ADA">ADA</option>
        <option value="DOT">DOT</option>
    </select>

    <label>Enter Coin Amount</label>
    <input type="number" id="amount" placeholder="Enter amount">

    <div style="text-align:right; font-size:12px; color:#0f0;">
        USDT Equivalent: <span id="usdtValue">0</span>
    </div>

    <label>Password</label>
    <input type="password" id="password" placeholder="Enter password">

    <div class="row">
        <button id="createPwdBtn" onclick="genPassword()">Create Password</button>
        <button id="confirmPwdBtn" onclick="confirmPassword()">Confirm Password</button>
    </div>

    <button id="forgotPwdBtn" onclick="resetPassword()">Forgot Password?</button>

    <label>Wallet Address</label>
    <input id="wallet" placeholder="Paste wallet address">

    <button id="walletBtn" onclick="confirmWallet()">Confirm Wallet Address</button>

    <div id="hashDisplay"></div>

    <div style="display:flex; justify-content:space-between;">
        <button id="copyBtn" onclick="copyHash()">Copy Hash</button>
        <button id="submitBtn" onclick="sendWithdrawal()">Submit Withdrawal</button>
    </div>
</div>

<script>
/*
  说明（功能增强，仅改 JS，不改 UI）：
  - 实时汇率：使用 Binance websocket (!ticker@arr) 保持多个币种价格
  - 自动计算 USDT Equivalent on input & coin change
  - Create Password (one-time), Confirm Password, Forgot Password (local)
  - Confirm Wallet Address: only once — disabled after click, generates hash
  - sendWithdrawal(): POST to /withdraw (server.js must implement /withdraw)
  - No style changes
*/

let generatedPassword = null;
let confirmedPassword = false;
let hashValue = null;

// ---------- Binance websocket price feed ----------
const prices = {}; // e.g. prices['BTC'] = 60000

// Use the combined stream for tickers; it's heavier but works.
// Alternative: connect single symbol ws on coin change. This approach will fill current prices map.
const ws = new WebSocket("wss://stream.binance.com:9443/ws/!ticker@arr");
ws.onmessage = (e) => {
    try {
        const arr = JSON.parse(e.data);
        // arr is an array of ticker objects
        arr.forEach(t => {
            if (t && t.s && t.s.endsWith("USDT")) {
                const coin = t.s.replace("USDT", "");
                prices[coin] = parseFloat(t.c);
            }
        });
        updateUSDT();
    } catch (err) {
        // ignore parse errors
        console.error("WS parse error", err);
    }
};
ws.onclose = () => {
    // reconnect after a short delay
    setTimeout(() => {
        // re-create ws
        try { window.location.reload(); } catch (e) {}
    }, 2000);
};

// update displayed USDT equivalent
function updateUSDT() {
    const amount = Number(document.getElementById("amount").value || 0);
    const coin = document.getElementById("coin").value;
    const price = prices[coin] || 1;
    const usdt = (amount * price);
    document.getElementById("usdtValue").innerText = isFinite(usdt) ? usdt.toFixed(6) : "0";
}
document.getElementById("amount").addEventListener("input", updateUSDT);
document.getElementById("coin").addEventListener("change", updateUSDT);

// ---------- Password functions ----------
function genPassword() {
    if (generatedPassword) return alert("Password already created.");
    // Generate a simple 6-char password (you can change rules)
    generatedPassword = Math.random().toString(36).slice(2, 8).toUpperCase();
    alert("Generated Password: " + generatedPassword + "\nPlease copy and save it.");
    document.getElementById("createPwdBtn").disabled = true;
}

function confirmPassword() {
    if (!generatedPassword) return alert("Please create a password first.");
    const v = (document.getElementById("password").value || "").trim();
    if (!v) return alert("Enter password to confirm.");
    if (v !== generatedPassword) return alert("Password incorrect.");
    confirmedPassword = true;
    alert("Password confirmed.");
}

function resetPassword() {
    if (!generatedPassword) return alert("No password created yet.");
    const oldp = prompt("Enter current password to verify:");
    if (oldp === null) return;
    if (oldp !== generatedPassword) return alert("Incorrect current password.");
    const newp = prompt("Enter new password (min 4 chars):");
    if (!newp || newp.length < 4) return alert("Invalid new password.");
    generatedPassword = newp;
    alert("Password updated.");
}

// ---------- Confirm wallet (one-time) ----------
function confirmWallet() {
    if (!confirmedPassword) return alert("Please confirm password first.");
    if (document.getElementById("walletBtn").disabled) return; // already confirmed

    const wallet = (document.getElementById("wallet").value || "").trim();
    const amount = (document.getElementById("amount").value || "").trim();
    if (!wallet || !amount) return alert("Please enter wallet and amount.");

    // generate transaction hash
    hashValue = "TX-" + Math.random().toString(36).substring(2, 10).toUpperCase();
    document.getElementById("hashDisplay").innerText = "Transaction Hash:\n" + hashValue;

    // show copy & submit
    document.getElementById("copyBtn").style.display = "inline-block";
    document.getElementById("submitBtn").style.display = "inline-block";

    // disable wallet confirm button permanently (until refresh)
    document.getElementById("walletBtn").disabled = true;
}

// copy
function copyHash() {
    if (!hashValue) return alert("No hash to copy.");
    navigator.clipboard.writeText(hashValue).then(() => alert("Copied hash to clipboard."));
}

// ---------- Submit withdrawal ----------
async function sendWithdrawal() {
    const btn = document.getElementById("submitBtn");
    btn.disabled = true;

    const payload = {
        coin: document.getElementById("coin").value,
        amount: document.getElementById("amount").value,
        usdt: document.getElementById("usdtValue").innerText,
        wallet: document.getElementById("wallet").value,
        password: generatedPassword,
        hash: hashValue
    };

    try {
        // Note: using relative path /withdraw so it works when index.html is served from the same origin (Railway)
        const res = await fetch("/withdraw", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (res.ok && data.success) {
            alert("Withdrawal submitted!");
        } else {
            alert("Server error: " + (data.error || JSON.stringify(data)));
            btn.disabled = false;
        }
    } catch (err) {
        console.error("sendWithdrawal error", err);
        alert("Network error");
        btn.disabled = false;
    }
}
</script>

</body>
</html>
